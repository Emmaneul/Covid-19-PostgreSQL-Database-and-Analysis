-- COVID 19 DATA ANALYST PROJECT
-- BY EMMANUEL NDIVHUWO MASINDI
-- DATE 27 SEPTEMBER 2021

-- BY EMMANUEL NDIVHUWO MASINDI
-- DATE 27 SEPTEMBER 2021

-- IMPORT DATASET


CREATE TABLE covid_data(
iso_code VARCHAR(50),
continent VARCHAR(50),
location VARCHAR(150),
date DATE,
total_cases BIGINT,
new_cases INTEGER,
total_deaths BIGINT,
new_deaths INTEGER,
icu_patients BIGINT,
hosp_patients BIGINT,
weekly_icu_admissions NUMERIC,
weekly_hosp_admissions NUMERIC,
new_tests INTEGER,
total_tests BIGINT,
total_vaccinations BIGINT,
people_vaccinated BIGINT,
people_fully_vaccinated BIGINT,
total_boosters BIGINT,
new_vaccinations BIGINT,
population BIGINT,
population_density NUMERIC,
median_age NUMERIC,
aged_65_older NUMERIC,
aged_70_older NUMERIC,
gdp_per_capita NUMERIC,
handwashing_facilities NUMERIC,
life_expectancy NUMERIC
)


SELECT * FROM covid_data

-- DATA EXPLORATION
-- TOTAL CASES AND DEATHS OVER TIME

SELECT continent, location, date, total_cases, total_deaths FROM covid_data
WHERE continent IS NOT null AND location ILIKE '%south af%'
ORDER BY 2,3

-- DETERMINE CASE FATALITY RATE (RECORDED_CASES/DEATHS)

SELECT continent, location, date, total_cases, total_deaths, 100 * (total_deaths) * (total_cases)^(-1) as case_fatality_rate
FROM covid_data
WHERE continent IS NOT null --AND location ILIKE '%south af%'
ORDER BY 2,3

-- COUNTRY PERCENTAGE OF POPULATION INFECTED PER COUNTRY

SELECT location, MAX(total_cases) AS total_cases , MAX(100*total_cases * population^(-1)) AS population_infection_rate FROM covid_data
WHERE continent IS NOT null
GROUP BY location, population
HAVING MAX(total_cases) IS NOT null
ORDER BY population_infection_rate DESC

-- COUNTRY PERCENTAGE DEATHS PER POPULATION

SELECT location, MAX(total_deaths) AS total_deaths , MAX(100*total_deaths * population^(-1)) AS population_death_rate FROM covid_data
WHERE continent IS NOT null
GROUP BY location, population
HAVING MAX(total_deaths) IS NOT null
ORDER BY population_death_rate DESC

--TOTAL CASES AND DEATHS

SELECT SUM(new_deaths) AS total_deaths , SUM(new_cases) AS total_cases, SUM(new_vaccinations) as total_vaccinations FROM covid_data
WHERE continent IS NOT null

-- CONTINENT PERCENTAGE DEATHS PER POPULATION 

SELECT continent, MAX(total_deaths) AS total_cases , MAX(100*total_deaths * population^(-1)) AS population_death_rate FROM covid_data
WHERE continent IS NOT null
GROUP BY continent
HAVING MAX(total_deaths) IS NOT null
ORDER BY population_death_rate DESC

--DETERMINE ICU ADMISSION RATE

SELECT location, date, total_cases, icu_patients, 100 * icu_patients * total_cases^(-1) AS icu_rate
FROM covid_data
WHERE icu_patients IS NOT null AND continent IS NOT null
ORDER BY 1,2

--DETERMINE TESTING PER COUNTRY BUT ONLY FOR 15 COUNTRIES WITH THE HIGHEST NUMBER OF CASES

SELECT location, date, SUM(new_tests) OVER (PARTITION by location ORDER BY location, date) as total_new_tests
FROM covid_data
WHERE icu_patients IS NOT null AND continent IS NOT null AND location IN

--USING CTE

(WITH Top_15_Countries_Case(location, total_cases)
AS
(
SELECT location, SUM(new_cases) FROM covid_data
WHERE continent IS NOT null
GROUP BY location
HAVING AVG(total_cases) IS NOT null
ORDER BY 2 DESC
LIMIT 15
)

SELECT location FROM Top_15_Countries_Case)

--DETERMINE TOTAL CASES AND VACCINATION RATES

SELECT location, date, new_cases, 100 * total_vaccinations * population ^ (-1) AS vaccination_rate
FROM covid_data
WHERE icu_patients IS NOT null AND continent IS NOT null AND location IN

--USING CTE

(WITH Top_15_Countries_Case(location, total_cases)
AS
(
SELECT location, SUM(new_cases) FROM covid_data
WHERE continent IS NOT null
GROUP BY location
HAVING AVG(total_cases) IS NOT null
ORDER BY 2 DESC
LIMIT 15
)

SELECT location FROM Top_15_Countries_Case)

